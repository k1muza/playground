
/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset allows public read access to most content (courses, problems, etc.)
 * while enforcing strict user ownership for user-generated content (submissions).
 *
 * Data Structure:
 * - Public content (courses, lessons, problems, etc.) are in top-level collections.
 * - Test cases are in a subcollection: `/problems/{problemId}/testCases/{testCaseId}`.
 * - Submissions are in a subcollection: `/problems/{problemId}/submissions/{submissionId}`.
 * - User profiles are in `/users/{userId}`.
 *
 * Key Security Decisions:
 * - Public read access is granted to course, lesson, problem, test case, article, tag, and topic data.
 * - User listing is disallowed for privacy.
 * - Submissions are strictly owned by the user who created them. A user can only create a submission
 *   if the `userId` in the document matches their auth UID.
 * - A collection group query on `submissions` is allowed, but only if the query includes a `where('userId', '==', request.auth.uid)` clause, ensuring users can only list their own submissions across all problems.
 *
 * Access Control Pattern:
 * - Courses, Lessons, Problems, TestCases, Articles, Tags, Topics: Public Read
 * - Users: Owner Only (Self-Creation)
 * - Submissions (Subcollection):
 *   - Create: Owner only (request.resource.data.userId == request.auth.uid)
 *   - Read/List: Publicly readable within a problem context.
 * - Submissions (Collection Group):
 *   - List: Owner only, requires a `where` filter on `userId`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper functions
     */
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource != null;
    }

    match /courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /problems/{problemId} {
      allow get, list: if true;
      allow create, update: if true; // WARNING: This is open for now. Should be restricted to admins.
      allow delete: if false;

      match /testCases/{testCaseId} {
        allow get, list: if true;
        allow create, update: if true; // WARNING: This is open for now. Should be restricted to admins.
        allow delete: if false;
      }
      
      /**
       * @description Controls access to submissions for a specific problem.
       * @path /databases/{database}/documents/problems/{problemId}/submissions/{submissionId}
       * @allow (get, list) Anyone can read submissions for a given problem.
       * @allow (create) User can create a submission if the `userId` in the new document matches their auth UID.
       * @deny (update, delete) Submissions are immutable once created.
       */
      match /submissions/{submissionId} {
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if false;
      }
    }

    /**
     * @description Collection group rule for `submissions`.
     * This allows a user to query for all of their own submissions across all problems,
     * which is essential for features like displaying a "solved" status next to problems.
     * The `where` clause in the query is enforced by the security rule.
     */
    match /{path=**}/submissions/{submissionId} {
      allow list: if isSignedIn() && request.query.where.size() == 1 && request.query.where[0].field == "userId" && request.query.where[0].op == "==" && request.query.where[0].value == request.auth.uid;
    }

    match /articles/{articleId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /tags/{tagId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /topics/{topicId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /users/{userId} {
      allow create: if isSignedIn() && isOwner(userId);
      allow get, update, delete: if isOwner(userId);
      allow list: if false;
    }
  }
}
    